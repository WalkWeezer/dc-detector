#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Fire Detection System Ð´Ð»Ñ Raspberry Pi
# ÐÐ²Ñ‚Ð¾Ñ€: DC-Detector Project
# Ð’ÐµÑ€ÑÐ¸Ñ: 1.0

echo "ðŸ”¥ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Fire Detection System Ð´Ð»Ñ Raspberry Pi"
echo "=================================================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð° Raspberry Pi
if ! grep -q "Raspberry Pi" /proc/cpuinfo; then
    echo "âš ï¸  Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð´Ð»Ñ Raspberry Pi"
    read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
sudo apt update && sudo apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
sudo apt install -y \
    python3-pip \
    python3-venv \
    python3-opencv \
    libopencv-dev \
    libhdf5-dev \
    libhdf5-serial-dev \
    libatlas-base-dev \
    libjasper-dev \
    libqtgui4 \
    libqt4-test \
    libqt4-dev \
    libqt4-opengl-dev \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libxvidcore-dev \
    libx264-dev \
    libgtk-3-dev \
    libtbb2 \
    libtbb-dev \
    libdc1394-dev \
    v4l-utils \
    git \
    wget \
    curl

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ
echo "ðŸ“· ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹..."
sudo raspi-config nonint do_camera 0
echo "âœ… ÐšÐ°Ð¼ÐµÑ€Ð° Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒÑÑ."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo "ðŸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
python3 -m venv fire_detection_env
source fire_detection_env/bin/activate

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pip
echo "â¬†ï¸  ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ pip..."
pip install --upgrade pip

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PyTorch Ð´Ð»Ñ ARM64 (Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
echo "ðŸ§  Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PyTorch Ð´Ð»Ñ Raspberry Pi..."
pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install -r requirements.txt

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p logs
mkdir -p models

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "âš™ï¸  ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
sudo tee /etc/systemd/system/fire-detection.service > /dev/null <<EOF
[Unit]
Description=Fire Detection System
After=network.target

[Service]
Type=simple
User=pi
WorkingDirectory=$(pwd)
Environment=PATH=$(pwd)/fire_detection_env/bin
ExecStart=$(pwd)/fire_detection_env/bin/python app_pi.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd
sudo systemctl daemon-reload

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "ðŸš€ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
cat > start_fire_detection.sh << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
source fire_detection_env/bin/activate
python app_pi.py
EOF

chmod +x start_fire_detection.sh

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
echo "ðŸ›‘ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸..."
cat > stop_fire_detection.sh << 'EOF'
#!/bin/bash
sudo systemctl stop fire-detection
EOF

chmod +x stop_fire_detection.sh

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
chmod +x *.sh
chown -R pi:pi .

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ IP Ð°Ð´Ñ€ÐµÑ
IP_ADDRESS=$(hostname -I | awk '{print $1}')

echo ""
echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "========================"
echo ""
echo "ðŸŒ Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:"
echo "   http://$IP_ADDRESS:5000"
echo "   http://localhost:5000"
echo ""
echo "ðŸš€ ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:"
echo "   Ð—Ð°Ð¿ÑƒÑÐº:     ./start_fire_detection.sh"
echo "   ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:  ./stop_fire_detection.sh"
echo "   ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº: sudo systemctl enable fire-detection"
echo "   Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:     sudo systemctl status fire-detection"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ PiCamera Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°"
echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ: ./start_fire_detection.sh"
echo "3. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð¸ Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ Ð²Ñ‹ÑˆÐµ"
echo ""
echo "âš ï¸  Ð’Ð°Ð¶Ð½Ð¾: ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Raspberry Pi Ð´Ð»Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ð¼ÐµÑ€Ñ‹!"
echo "   sudo reboot"
echo ""

# Ð¡Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
read -p "ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Raspberry Pi ÑÐµÐ¹Ñ‡Ð°Ñ? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."
    sudo reboot
fi

#!/bin/bash

# ðŸ”¥ DC-Detector - Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
# ÐÐ²Ñ‚Ð¾Ñ€: DC-Detector Team
# Ð’ÐµÑ€ÑÐ¸Ñ: 1.0

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE} $1${NC}"
    echo -e "${BLUE}================================${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python
check_python() {
    print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python..."
    
    if command -v python3 >/dev/null 2>&1; then
        local python_version=$(python3 --version 2>&1)
        print_success "Python Ð½Ð°Ð¹Ð´ÐµÐ½: $python_version"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÑ€ÑÐ¸Ð¸
        local version=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
        if [ "$(echo "$version >= 3.8" | bc -l 2>/dev/null || echo "1")" = "1" ]; then
            print_success "Ð’ÐµÑ€ÑÐ¸Ñ Python Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð°Ñ: $version"
        else
            print_warning "Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Python 3.8+, Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: $version"
        fi
    else
        print_error "Python3 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        print_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Python3: sudo apt install python3 python3-pip python3-venv"
        exit 1
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° venv Ð¼Ð¾Ð´ÑƒÐ»Ñ
check_venv_module() {
    print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð¾Ð´ÑƒÐ»Ñ venv..."
    
    if python3 -m venv --help >/dev/null 2>&1; then
        print_success "ÐœÐ¾Ð´ÑƒÐ»ÑŒ venv Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
    else
        print_error "ÐœÐ¾Ð´ÑƒÐ»ÑŒ venv Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        print_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ python3-venv: sudo apt install python3-venv"
        exit 1
    fi
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
create_venv() {
    print_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    
    if [ -d "fire_detection_env" ]; then
        print_warning "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
        read -p "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
            rm -rf fire_detection_env
        else
            print_info "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ"
            return 0
        fi
    fi
    
    print_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    python3 -m venv fire_detection_env
    
    if [ -d "fire_detection_env" ]; then
        print_success "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾"
    else
        print_error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ"
        exit 1
    fi
}

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
setup_dependencies() {
    print_info "ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    source fire_detection_env/bin/activate
    
    print_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ pip..."
    pip install --upgrade pip
    
    if [ -f "requirements.txt" ]; then
        print_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸Ð· requirements.txt..."
        pip install -r requirements.txt
        print_success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
    else
        print_warning "Ð¤Ð°Ð¹Ð» requirements.txt Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        print_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
        pip install opencv-python ultralytics flask numpy pillow
        print_success "ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
verify_installation() {
    print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸..."
    
    source fire_detection_env/bin/activate
    
    local modules=("cv2" "ultralytics" "flask" "numpy" "PIL")
    local missing_modules=()
    
    for module in "${modules[@]}"; do
        if python3 -c "import $module" 2>/dev/null; then
            print_success "ÐœÐ¾Ð´ÑƒÐ»ÑŒ $module ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        else
            print_error "ÐœÐ¾Ð´ÑƒÐ»ÑŒ $module Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
            missing_modules+=("$module")
        fi
    done
    
    if [ ${#missing_modules[@]} -ne 0 ]; then
        print_error "ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¼Ð¾Ð´ÑƒÐ»Ð¸: ${missing_modules[*]}"
        print_info "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ: pip install ${missing_modules[*]}"
        return 1
    fi
    
    print_success "Ð’ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸
create_activation_script() {
    print_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸..."
    
    cat > activate_env.sh << 'EOF'
#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ DC-Detector

if [ -d "fire_detection_env" ]; then
    source fire_detection_env/bin/activate
    echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ DC-Detector Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾"
    echo "Ð”Ð»Ñ Ð´ÐµÐ°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: deactivate"
else
    echo "âŒ Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
    echo "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: ./create_venv.sh"
    exit 1
fi
EOF
    
    chmod +x activate_env.sh
    print_success "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½: activate_env.sh"
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    print_header "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ DC-Detector"
    
    check_python
    check_venv_module
    create_venv
    setup_dependencies
    verify_installation
    create_activation_script
    
    print_header "Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!"
    print_success "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾"
    print_info "Ð”Ð»Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ:"
    echo "  source fire_detection_env/bin/activate"
    echo "  Ð¸Ð»Ð¸"
    echo "  ./activate_env.sh"
    echo ""
    print_info "Ð”Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:"
    echo "  ./start_fire_detection.sh"
}

# Ð—Ð°Ð¿ÑƒÑÐº
main "$@"

services:
  init:
    image: alpine:latest
    working_dir: /workspace
    volumes:
      - .:/workspace
    command: >-
      sh -c "
      echo 'üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞...' &&
      if [ ! -f .env ]; then \
        if [ -f env.example ]; then \
          cp env.example .env && \
          echo '‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏–∑ env.example'; \
        else \
          touch .env && \
          echo '‚ö†Ô∏è  –°–æ–∑–¥–∞–Ω –ø—É—Å—Ç–æ–π .env —Ñ–∞–π–ª'; \
        fi; \
      else \
        echo '‚ÑπÔ∏è  .env —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'; \
      fi && \
      mkdir -p data/detections/saved && \
      mkdir -p services/detection/models && \
      echo '‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã' && \
      echo '‚ú® –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'"
  backend:
    env_file: .env
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    environment:
      - PORT=8080
      - DETECTION_URL=http://detection:8001
    depends_on:
      init:
        condition: service_completed_successfully
      detection:
        condition: service_started
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
    networks: [app]

  detection:
    depends_on:
      init:
        condition: service_completed_successfully
    env_file: .env
    build:
      context: .
      dockerfile: docker/detection.Dockerfile
    environment:
      - CAMERA_INDEX=0
      - CAMERA_SCAN_LIMIT=5
      - MODEL_PATH=models/bestfire.pt
      - BACKEND_NOTIFY_URL=http://backend:8080/internal/detections
    dns:
      - 8.8.8.8
      - 1.1.1.1
    volumes:
      - ./services/detection/models:/app/models
    networks: [app]

  frontend:
    depends_on:
      backend:
        condition: service_started
      init:
        condition: service_completed_successfully
    build:
      context: .
      dockerfile: docker/frontend.Dockerfile
    ports:
      - "80:80"
      - "443:443"
    networks: [app]

networks:
  app: {}

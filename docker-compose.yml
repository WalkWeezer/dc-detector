services:
  init:
    image: alpine:latest
    working_dir: /workspace
    volumes:
      - .:/workspace
    command: >-
      sh -c "
      echo 'üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞...' &&
      if [ ! -f .env ]; then \
        if [ -f env.example ]; then \
          cp env.example .env && \
          echo '‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏–∑ env.example'; \
        else \
          touch .env && \
          echo '‚ö†Ô∏è  –°–æ–∑–¥–∞–Ω –ø—É—Å—Ç–æ–π .env —Ñ–∞–π–ª'; \
        fi; \
      else \
        echo '‚ÑπÔ∏è  .env —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'; \
      fi && \
      mkdir -p data/detections/saved && \
      mkdir -p services/detection/models && \
      echo '‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã' && \
      echo '‚ú® –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'"
  backend:
    env_file: .env
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    environment:
      - PORT=8080
      - DETECTION_URL=${DETECTION_URL:-http://host.docker.internal:8001}
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
    networks: [app]

  # Detection service –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç Docker
  # –ó–∞–ø—É—Å—Ç–∏—Ç–µ: cd services/detection && python detection_server.py

  frontend:
    depends_on:
      backend:
        condition: service_started
      init:
        condition: service_completed_successfully
    build:
      context: .
      dockerfile: docker/frontend.Dockerfile
    ports:
      - "80:80"
      - "443:443"
    networks: [app]

networks:
  app: {}
